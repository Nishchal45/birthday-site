<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="robots" content="noindex, nofollow" />
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>🎈 Birthday Surprise</title>
  <meta name="description" content="A celebratory birthday microsite with balloons, confetti, and playful animations." />
  <style>
    :root{
      --frame-ratio: 4 / 5;
      --frame-width: clamp(240px, 62vmin, 420px);
      --bg: #0b0f1a;
      --bg-2: radial-gradient(1200px 800px at 20% 10%, #1a1f33 0%, transparent 60%),
              radial-gradient(900px 700px at 80% 80%, #161b2b 0%, transparent 60%),
              radial-gradient(1000px 700px at 50% 50%, #0e1322 0%, transparent 60%);
      --accent: #ff7bd3; --accent-2:#ffd166; --accent-3:#66e5ff; --accent-4:#b5ff7b;
      --text: #f7f8ff; --muted:#9aa3b2;
    }
    *{ box-sizing: border-box; }
    html, body{ height: 100%; margin: 0; background: var(--bg); color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; overflow: hidden; }
    @media (prefers-reduced-motion: reduce){
      *{ animation-duration:0.001ms!important; animation-iteration-count:1!important; transition-duration:0.001ms!important; }
    }
    .center{ display:grid; place-items:center; }
    .hidden{ opacity:0; pointer-events:none; }
    .btn{ appearance:none; border:none; cursor:pointer; padding:14px 28px; border-radius:999px;
      font-weight:700; font-size:clamp(16px,2.2vw,18px); color:#0b0f1a;
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      box-shadow:0 10px 30px rgba(255,123,211,.35), inset 0 1px 0 rgba(255,255,255,.5);
      transition: transform .15s ease, box-shadow .2s ease; }
    .btn:hover{ transform: translateY(-2px) scale(1.02); box-shadow:0 16px 38px rgba(255,123,211,.45); }
    .btn:active{ transform: translateY(1px) scale(.98); }
    .scene{ position:absolute; inset:0; width:100%; height:100%;
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(255,255,255,.06) 0%, transparent 60%),
        radial-gradient(1000px 700px at 90% 70%, rgba(255,255,255,.04) 0%, transparent 60%),
        var(--bg-2), var(--bg);
      transition: opacity .8s ease, filter .8s ease; }
    .intro{ display:grid; place-items:center; text-align:center; padding:4vmin; }
    .intro .card{ width:min(820px,94vw); padding:clamp(22px,4.5vmin,40px); border-radius:28px;
      backdrop-filter: blur(10px);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow:0 24px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06);}
    .headline{ font-size:clamp(28px,6vw,56px); line-height:1.08; font-weight:900; letter-spacing:.2px;
      background:linear-gradient(180deg,#fff,#dfe8ff); -webkit-background-clip:text; background-clip:text; color:transparent; margin:0 0 14px; }
    .subtext{ color:var(--muted); font-size:clamp(16px,2.5vw,20px); margin:0 0 26px; }
    .type{ display:inline-block; border-right:3px solid var(--accent-2); white-space:nowrap; overflow:hidden; }
    .celebrate{ position:absolute; inset:0; overflow:hidden; }
    canvas#confetti, #finalConfetti{ position:absolute; inset:0; width:100%; height:100%; pointer-events:none; }
    .balloon{ position:absolute; bottom:-20vh; width:60px; height:80px; border-radius:40px 40px 45px 45px/50px 50px 30px 30px;
      background: radial-gradient(120% 120% at 30% 25%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.35) 8%, rgba(255,255,255,.18) 16%, rgba(255,255,255,0) 28%),
                  radial-gradient(140% 140% at 70% 70%, rgba(0,0,0,.35) 0%, rgba(0,0,0,.2) 20%, rgba(0,0,0,0) 60%), var(--color);
      box-shadow: inset 0 -8px 18px rgba(0,0,0,.18); transform: translateY(0) translateX(0) rotate(0deg);
      animation: floatUp linear forwards; cursor:pointer; }
    .balloon:after{ content:""; position:absolute; bottom:-8px; left:50%; transform:translateX(-50%);
      border-left:8px solid transparent; border-right:8px solid transparent; border-top:12px solid rgba(0,0,0,.25); filter: blur(.2px); }
    .string{ position:absolute; top:80px; left:50%; width:1.5px; height:120px; background:rgba(255,255,255,.5);
      transform-origin: top; transform: translateX(-50%) rotate(0deg); animation:sway 3.2s ease-in-out infinite; }
    @keyframes sway{0%,100%{transform:translateX(-50%) rotate(-4deg)}50%{transform:translateX(-50%) rotate(4deg)}}
    @keyframes floatUp{0%{transform:translateY(0) translateX(0) rotate(0); opacity:0}10%{opacity:1}100%{transform:translateY(-130vh) translateX(var(--drift)) rotate(var(--rot)); opacity:1}}
    .msg{ position:absolute; top:8%; left:50%; transform:translateX(-50%); text-align:center;
      font-size:clamp(24px,5.5vw,56px); font-weight:900; letter-spacing:.4px; background:linear-gradient(180deg,#fff,#ffe6fb);
      -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 4px 20px rgba(255,123,211,.25);
      filter: drop-shadow(0 10px 30px rgba(0,0,0,.45)); }
    .msg small{ display:block; font-size:clamp(14px,2.3vw,18px); color:var(--muted); -webkit-text-fill-color: initial; text-shadow:none; }
    .sparkle{ position:absolute; width:6px; height:6px; border-radius:50%; background:#fff; opacity:.8; filter: blur(.5px); animation: twinkle 2.5s ease-in-out infinite; }
    @keyframes twinkle{0%,100%{transform:scale(1); opacity:.6}50%{transform:scale(1.8); opacity:1}}
    .controls{ position:absolute; bottom:14px; left:50%; transform:translateX(-50%); display:flex; gap:10px; align-items:center; padding:8px 12px; border-radius:999px; background: rgba(255,255,255,.06); box-shadow: inset 0 1px 0 rgba(255,255,255,.08);}
    .toggle{ display:flex; align-items:center; gap:8px; font-size:14px; color:var(--muted); }
    input[type="checkbox"]{ width:38px; height:22px; border-radius:999px; appearance:none; background:#3a415a; position:relative; outline:none; cursor:pointer; transition:background .2s ease; }
    input[type="checkbox"]::before{ content:""; position:absolute; width:18px; height:18px; background:#fff; border-radius:50%; top:2px; left:2px; transition:left .2s ease; box-shadow:0 2px 6px rgba(0,0,0,.35) }
    input[type="checkbox"]:checked{ background:linear-gradient(135deg, var(--accent), var(--accent-2)); }
    input[type="checkbox"]:checked::before{ left:18px; }
    .fade-out{ opacity:0; filter: blur(3px); }
    .fade-in{ animation: fadeIn .8s ease forwards; }
    @keyframes fadeIn{ from{opacity:0; filter:blur(6px)} to{opacity:1; filter:blur(0)} }
    @media (max-width:480px){ .string{height:90px} .balloon{width:48px; height:64px} }
    .gallery-wrap{ position:absolute; inset:0; display:grid; grid-template-rows:auto 1fr auto; padding: clamp(14px,4vmin,28px); gap:14px; }
    .gallery-title{ text-align:center; font-size:clamp(22px,5vw,44px); margin:0; font-weight:900; background: linear-gradient(180deg,#fff,#ffe6fb); -webkit-background-clip:text; background-clip:text; color:transparent; }
    .gallery-sub{ text-align:center; margin:0; color:var(--muted); }
    .carousel{ position:relative; overflow:hidden; border-radius:20px; padding:10px; min-height:min(70vh,640px); display:block; }
    .carousel .track{ display:flex; gap:var(--gap,18px); align-items:center; justify-content:flex-start; will-change: transform; transition: transform .6s cubic-bezier(.22,1,.36,1); height:100%; }
    .carousel .card{ flex:0 0 var(--frame-width); width:var(--frame-width); max-width:none; display:flex; flex-direction:column; align-items:center; }
    .polaroid{ position:relative; background:#fff; border-radius:16px; padding:10px 10px 18px; box-shadow:0 30px 60px rgba(0,0,0,.35); transform: rotate(var(--tilt,-1deg)); width: var(--frame-width); display:flex; flex-direction:column; align-items:center; }
    .polaroid img{ width:100%; height:auto; aspect-ratio: var(--frame-ratio); object-fit:cover; object-position:center; border-radius:10px; filter:saturate(1.05) contrast(1.05); display:block; }
    .img-fallback{ width:100%; aspect-ratio: var(--frame-ratio); border-radius:10px; display:grid; place-items:center; background: linear-gradient(135deg, #2b3148, #12182a); color:#fff; font-weight:700; letter-spacing:.4px; opacity:.9; }
    .gallery-controls{ display:flex; justify-content:center; gap:12px; }
    .card.entering{ animation: cardIn .5s cubic-bezier(.22,1,.36,1); }
    .card.leaving{ animation: cardOut .4s ease; }
    @keyframes cardIn{ from{ transform: scale(.9) rotate(-3deg); opacity:.7 } to{ transform: scale(1) rotate(-1deg); opacity:1 } }
    @keyframes cardOut{ from{ transform: scale(1) rotate(-1deg); opacity:1 } to{ transform: scale(.94) rotate(-2deg); opacity:.7 } }
    #track .card:nth-child(6){ padding:8px 8px 14px; }
    #track .card:nth-child(6) img{ aspect-ratio:3/4; object-position:50% 8%; }
    #galleryFx{ position:absolute; inset:0; pointer-events:none; overflow:hidden; }
    .confetto{ position:absolute; width:8px; height:8px; border-radius:2px; transform: translate(-50%,-50%); animation: confettiFly 900ms ease forwards; }
    @keyframes confettiFly{ 0%{ opacity:1; transform: translate(var(--x,0), var(--y,0)) scale(1) rotate(0deg) } 100%{ opacity:0; transform: translate(calc(var(--x,0) + var(--dx,0px)), calc(var(--y,0) - var(--dy,120px))) scale(.8) rotate(260deg) } }
    #scene-final{ overflow:hidden; }
    .final-card{ text-align:center; width:min(900px,92vw); padding: clamp(18px,4.5vmin,40px); border-radius:28px; background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)); backdrop-filter: blur(8px); box-shadow:0 24px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.06); }
    .final-title{ font-size:clamp(28px,6vw,64px); margin:0 0 10px; font-weight:900; letter-spacing:.5px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3), var(--accent-4));
      background-size:300% 100%; -webkit-background-clip:text; background-clip:text; color:transparent; animation:hueSlide 6s ease-in-out infinite alternate; }
    @keyframes hueSlide{ from{background-position:0% 50%} to{background-position:100% 50%} }
    .final-line{ color:var(--muted); font-size:clamp(15px,2.6vw,22px); margin:8px 0; }
    #scene-final .final-card{ position:relative; z-index:3; }
    .treats{ position:absolute; inset:0; pointer-events:none; overflow:hidden; z-index:1; }
    .treat{ position:absolute; left:50%; bottom:-20vh; width: var(--size,84px); height: var(--sizeH,84px);
      background-repeat:no-repeat; background-position:center; background-size:contain; opacity:.95;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35)); animation: floatTreat var(--dur,18s) linear var(--delay,0s) forwards; transform-origin:center; }
    @keyframes floatTreat{ 0%{ transform: translate(var(--x0,0px), 0vh) rotate(var(--rot,0deg)); opacity:.0 } 10%{ opacity:.9 }
      50%{ transform: translate(calc(var(--x0,0px) + var(--dx,0px)), -55vh) rotate(calc(var(--rot,0deg) + 6deg)); }
      100%{ transform: translate(calc(var(--x0,0px) + var(--dx2,0px)), -120vh) rotate(calc(var(--rot,0deg) + 12deg)); opacity:.95 } }
    .treat.slice{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><polygon points='10,36 46,18 54,24 18,42' fill='%23ffe3b3' stroke='%23d9a25f' stroke-width='2'/><polygon points='10,36 18,42 18,50 10,44' fill='%23c68a4a'/><rect x='18' y='42' width='36' height='8' fill='%23c68a4a'/><ellipse cx='30' cy='21' rx='12' ry='4' fill='%23ffcf87'/><circle cx='40' cy='22' r='4.5' fill='%23ff7bd3' stroke='%23d9488e' stroke-width='1.2'/></svg>"); }
    .treat.mug{ background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='10' y='18' width='34' height='28' rx='6' fill='%23ffffff' stroke='%233b3f55' stroke-width='2'/><path d='M44 24 q12 0 12 10 t-12 10' fill='none' stroke='%23ffffff' stroke-width='10'/><path d='M44 24 q12 0 12 10 t-12 10' fill='none' stroke='%233b3f55' stroke-width='2'/><rect x='12' y='20' width='30' height='8' rx='4' fill='%23d6f0ff'/><rect x='12' y='26' width='30' height='18' fill='%23ffffff'/><rect x='12' y='26' width='30' height='6' fill='%238b5e3c'/></svg>"); }
    .treat.mug::after{ content:""; position:absolute; left:50%; top:14%; transform:translateX(-50%); width:26%; height:48%;
      background: radial-gradient(50% 60% at 50% 80%, rgba(255,255,255,.6), rgba(255,255,255,0) 60%); filter: blur(1px); opacity:.0; animation: steamRise 2.6s ease-in-out infinite; }
    .treat.mug::before{ content:""; position:absolute; left:60%; top:16%; transform:translateX(-50%); width:18%; height:40%;
      background: radial-gradient(50% 60% at 50% 80%, rgba(255,255,255,.5), rgba(255,255,255,0) 60%); filter: blur(1.2px); opacity:.0; animation: steamRise 2.9s ease-in-out infinite .8s; }
    @keyframes steamRise{ 0%{ transform: translate(-50%, 10px) scale(.9); opacity:0 } 40%{ opacity:.55 } 100%{ transform: translate(-50%, -26px) scale(1.05); opacity:0 } }
  </style>
</head>
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>

<body>
  <!-- Scene 1: Intro -->
  <section id="scene-intro" class="scene intro">
    <div class="card fade-in">
      <h3 class="headline"><span class="type" id="typeText"> It’s your special day My Lemonnnn...</span></h3s>
      <p class="subtext">Are you Excited for a little surprise?</p>
      <button id="btnYes" class="btn">Yes, show me 🎁</button>
      <p class="subtext" style="margin-top:16px; opacity:.7">Tip: turn on sound when it appears ↓</p>
    </div>
  </section>

  <!-- Scene 2: Celebration -->
  <section id="scene-celebrate" class="scene celebrate hidden" aria-hidden="true">
    <h2 class="msg" id="titleMsg">Happy Birthday, Dishaliii! <small>Wishing you laughter, light, and a sky full of balloons.</small><small></small></h2>
    <canvas id="confetti"></canvas>
    <div class="controls" role="group" aria-label="Controls">
      <label class="toggle">
        <input id="musicToggle" type="checkbox" />
        <span>Music</span>
      </label>
      <button id="btnNext" class="btn" style="padding:10px 18px; font-weight:800">Next →</button>
      <button id="btnReplay" class="btn" style="padding:10px 18px; font-weight:800">Replay 🎉</button>
    </div>
    <div id="sparkles" aria-hidden="true"></div>
  </section>

  <!-- Scene 3: Gallery -->
  <section id="scene-gallery" class="scene hidden" aria-hidden="true">
    <div class="gallery-wrap">
      <h2 class="gallery-title">Our Little Moments</h2>
      <p class="gallery-sub">Swipe/drag on mobile • Click arrows on desktop</p>
      <div class="carousel" id="carousel"><div class="track" id="track">
        <div class="card polaroid"><img src="assets/photo1.jpg" alt="memory 1"></div>
        <div class="card polaroid"><img src="assets/photo2.jpg" alt="memory 2"></div>
        <div class="card polaroid"><img src="assets/photo3.jpg" alt="memory 3"></div>
        <div class="card polaroid"><img src="assets/photo4.jpg" alt="memory 4"></div>
        <div class="card polaroid"><img src="assets/photo5.jpg" alt="memory 5"></div>
        <div class="card polaroid"><img src="assets/photo6.jpg" alt="memory 6"></div>
      </div></div>
      <div class="gallery-controls">
        <button id="prev" class="btn" aria-label="Previous">←</button>
        <button id="toFinal" class="btn">Continue ✨</button>
        <button id="next" class="btn" aria-label="Next">→</button>
      </div>
      <div id="galleryFx" aria-hidden="true"></div>
    </div>
  </section>

  <!-- Scene 4: Final message -->
  <section id="scene-final" class="scene center hidden" aria-hidden="true">
    <div class="treats" id="treats"></div>
    <div class="final-card">
      <h2 class="final-title">Happyyy Birthdayyyyy, <span id=""> My Cheeeesecake!!</span> 💖💕</h2>
      <p class="final-line">I wish for your life to be filled with gardens of joy, oceans of peace, and sunsets that leave you smiling. May every dream you cradle find its way to your hands, and may love follow you like a constant shadow.</p>
      <p></p>
      <p class="final-line">And if I may whisper a selfish wish… it’s that I get to keep walking beside you, turning ordinary days into extraordinary memories forever and always.</p>
      <p class="final-line"></p>
      <button id="btnFinalReplay" class="btn">One more time 🎈</button>
    </div>
    <canvas id="finalConfetti"></canvas>
  </section>

  <!-- Audio -->
  <audio id="bgm" loop preload="auto"></audio>

  <script>
    // Personalize name via ?name= in URL
    const params = new URLSearchParams(location.search);
    const who = params.get('name') || 'Dishali';
    const nameEl = document.getElementById('herName'); if (nameEl) nameEl.textContent = who;

    // Typewriter
    (function typewriter(){
      const el = document.getElementById('typeText');
      const full = "It’s your special day…";
      el.textContent = "";
      let i=0, speed=45;
      const tick = () => { if(i<=full.length){ el.textContent = full.slice(0,i++) + (i%2?"|":""); setTimeout(tick, speed);} else { el.textContent = full; } };
      tick();
    })();

    // Elements
    const intro = document.getElementById('scene-intro');
    const celebrate = document.getElementById('scene-celebrate');
    const gallery = document.getElementById('scene-gallery');
    const finalScene = document.getElementById('scene-final');
    const btnYes = document.getElementById('btnYes');
    const btnReplay = document.getElementById('btnReplay');
    const btnNext = document.getElementById('btnNext');
    const btnFinalReplay = document.getElementById('btnFinalReplay');
    const toFinalBtn = document.getElementById('toFinal');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const galleryFx = document.getElementById('galleryFx');
    const finalCanvas = document.getElementById('finalConfetti');
    const treats = document.getElementById('treats');
    const confettiCanvas = document.getElementById('confetti');
    const sparkles = document.getElementById('sparkles');

    const ctx = confettiCanvas.getContext('2d');
    const fctx = finalCanvas.getContext('2d');

    // DPR-aware canvas sizing
    function sizeCanvas(canvas, ctx){
      const dpr = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
      canvas.width  = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = '100%'; canvas.style.height = '100%';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    function resize(){ sizeCanvas(confettiCanvas, ctx); sizeCanvas(finalCanvas, fctx); }
    window.addEventListener('resize', resize); resize();

    // Confetti engine
    let W=confettiCanvas.width, H=confettiCanvas.height;
    let confettiPieces = [], rafId=null;
    function makeConfettiBurst(x, y, count=120){
      for(let i=0;i<count;i++){
        confettiPieces.push({
          x, y,
          vx:(Math.random()*2-1)*(4+Math.random()*4),
          vy:-(Math.random()*6+4),
          size:Math.random()*6+3,
          color: pick(["#ffd166","#ff7bd3","#66e5ff","#b5ff7b","#ffffff"]),
          life:0, spin:(Math.random()*2-1)*0.2, angle: Math.random()*Math.PI*2
        });
      }
    }
    function updateConfetti(){
      W = confettiCanvas.width; H = confettiCanvas.height;
      for(let i=confettiPieces.length-1; i>=0; i--){
        const p=confettiPieces[i];
        p.vy += 0.12; p.x += p.vx; p.y += p.vy; p.angle += p.spin; p.life++;
        if(p.y>H+40 || p.life>600) confettiPieces.splice(i,1);
      }
    }
    function drawConfetti(){
      ctx.clearRect(0,0,W,H);
      for(const p of confettiPieces){
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.angle); ctx.fillStyle=p.color;
        ctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); ctx.restore();
      }
    }
    function loop(){ updateConfetti(); drawConfetti(); rafId = requestAnimationFrame(loop); }
    loop();

    // Balloons
    const palette = ["#ff7bd3","#ffd166","#66e5ff","#b5ff7b","#c69eff","#ff9aa2"];
    let launching=false;
    function spawnBalloon(){
      const b = document.createElement('div'); b.className='balloon';
      const color = pick(palette);
      b.style.setProperty('--color', `radial-gradient(140% 140% at 30% 20%, ${lighten(color,40)} 0%, ${color} 55%, ${darken(color,20)} 100%)`);
      const x = Math.random()* (window.innerWidth-80) + 40;
      const delay = Math.random()*1000;
      const duration = 9000 + Math.random()*5000;
      const drift = (Math.random()*2-1) * (window.innerWidth*0.2) + 'px';
      const rot = ((Math.random()*2-1)*25)+'deg';
      b.style.left = (x-30)+'px'; b.style.animationDuration = duration+'ms'; b.style.animationDelay = delay+'ms';
      b.style.setProperty('--drift', drift); b.style.setProperty('--rot', rot);
      const s=document.createElement('div'); s.className='string'; b.appendChild(s);
      b.addEventListener('click', ()=>{
        const r=b.getBoundingClientRect();
        makeConfettiBurst(r.left + r.width/2, r.top + r.height/2, 160);
        b.remove();
      });
      celebrate.appendChild(b);
      setTimeout(()=>{ b.remove(); }, duration + delay + 2000);
    }
    function launchBalloons(durationMs=9000){
      if(launching) return; launching=true;
      const start=performance.now();
      const timer=setInterval(()=>{
        spawnBalloon();
        if(performance.now()-start > durationMs){ clearInterval(timer); launching=false; }
      },140);
    }

    // Sparkles
    function spawnSparkles(){
      const n=70;
      for(let i=0;i<n;i++){
        const sp=document.createElement('div'); sp.className='sparkle';
        sp.style.left = Math.random()*100+"%"; sp.style.top = Math.random()*100+"%";
        sp.style.animationDelay = (Math.random()*2)+'s'; sparkles.appendChild(sp);
      }
    }

    // Helpers
    function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
    function shade(hex, amt){
      hex=hex.replace('#',''); const num=parseInt(hex,16);
      let r=(num>>16)+amt; r=Math.max(Math.min(255,r),0);
      let g=(num>>8 & 0xFF)+amt; g=Math.max(Math.min(255,g),0);
      let b=(num & 0xFF)+amt; b=Math.max(Math.min(255,b),0);
      return '#'+(r<<16 | g<<8 | b).toString(16).padStart(6,'0');
    }
    const lighten=(h,a)=>shade(h,+a), darken=(h,a)=>shade(h,-a);
    function show(el){ el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
    function hide(el){ el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

    // AUDIO (minimal + safe)
    const musicToggle = document.getElementById('musicToggle');
    const bgm = document.getElementById('bgm');
    const MUSIC_URL = 'assets/hbd.mp3'; // <-- put your mp3 here
    function ensureSrc(){ if(!bgm.src){ bgm.src = MUSIC_URL; try{ bgm.load(); }catch(_){} } }
    async function primeAndPlay(){
      ensureSrc();
      try{ bgm.currentTime=0; await bgm.play(); if(musicToggle) musicToggle.checked=true; }
      catch(e){ console.warn('Audio couldn’t start:', e); }
    }
    if (musicToggle){
      musicToggle.addEventListener('change', async (e)=>{
        ensureSrc();
        if(e.target.checked){ try{ await primeAndPlay(); }catch(err){ console.warn('Play failed:', err);} }
        else{ try{ bgm.pause(); }catch(_){} }
      });
    }
    bgm.addEventListener('error', ()=>{ const code=(bgm.error && bgm.error.code)||'unknown'; console.warn('Audio error code:', code, 'URL:', MUSIC_URL); });

    // Transitions
    function toCelebration(){
      intro.classList.add('fade-out');
      // Start audio on same user gesture (best chance across browsers)
      primeAndPlay();
      setTimeout(()=>{
        hide(intro); show(celebrate);
        spawnSparkles();
        const {width:Wcss,height:Hcss}=confettiCanvas.getBoundingClientRect();
        makeConfettiBurst(Wcss*0.5, Hcss*0.25, 220);
        makeConfettiBurst(Wcss*0.2, Hcss*0.35, 120);
        makeConfettiBurst(Wcss*0.8, Hcss*0.35, 120);
        launchBalloons(13000);
        setTimeout(()=>{ toGallery(); }, 14000);
      },650);
    }
    function toGallery(){ hide(celebrate); show(gallery); setupCarousel(); }
    function toFinal(){
      hide(gallery); show(finalScene);
      spawnTreats(12);
      const {width:Wcss,height:Hcss}=finalCanvas.getBoundingClientRect();
      makeFinalBurst(Wcss*0.5, Hcss*0.4, 260);
      finalLoop();
    }

    // Buttons
    btnYes.addEventListener('click', toCelebration);
    btnNext.addEventListener('click', toGallery);
    btnReplay.addEventListener('click', ()=>{
      confettiPieces = []; document.querySelectorAll('.balloon').forEach(el=>el.remove());
      const {width:Wcss,height:Hcss}=confettiCanvas.getBoundingClientRect();
      makeConfettiBurst(Wcss*0.5, Hcss*0.25, 220); launchBalloons(12000);
    });
    toFinalBtn.addEventListener('click', toFinal);
    prevBtn.addEventListener('click', ()=>{ step(-1); galleryCelebrate(); });
    nextBtn.addEventListener('click', ()=>{ step(1); galleryCelebrate(); });
    btnFinalReplay.addEventListener('click', ()=>{ hide(finalScene); show(celebrate);
      confettiPieces=[]; finalPieces=[]; if(treats) treats.innerHTML='';
      const {width:Wcss,height:Hcss}=confettiCanvas.getBoundingClientRect();
      makeConfettiBurst(Wcss*0.5, Hcss*0.25, 220); launchBalloons(12000);
    });
    btnYes.addEventListener('keyup', (e)=>{ if(e.key==='Enter'||e.key===' '){ toCelebration(); } });

    // Carousel
    let idx=0, cards, carouselEl, trackEl, stepW=0, gap=18, cardW=0;
    function setupCarousel(){
      carouselEl=document.getElementById('carousel'); trackEl=document.getElementById('track');
      cards=Array.from(trackEl.children);
      cards.forEach(card=>{
        const img=card.querySelector('img');
        if(!img) return;
        img.addEventListener('error', ()=>{
          const ph=document.createElement('div'); ph.className='img-fallback'; ph.textContent='Image not found'; card.prepend(ph);
        },{once:true});
      });
      computeMetrics(); layout();
      let startX=0, curX=0, dragging=false;
      const onDown = (e)=>{ dragging=true; startX=(e.touches?e.touches[0].clientX:e.clientX); };
      const onMove = (e)=>{ if(!dragging) return; curX=(e.touches?e.touches[0].clientX:e.clientX); };
      const onUp   = ()=>{ if(!dragging) return; const diff=curX-startX; if(Math.abs(diff)>50){ step(diff>0?-1:1); galleryCelebrate(); } dragging=false; };
      trackEl.addEventListener('mousedown', onDown);
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
      trackEl.addEventListener('touchstart', onDown, {passive:true});
      trackEl.addEventListener('touchmove', onMove, {passive:true});
      trackEl.addEventListener('touchend', onUp);
      window.addEventListener('resize', ()=>{ computeMetrics(); layout(); });
      document.addEventListener('keydown', (e)=>{
        if(gallery.getAttribute('aria-hidden')==='false'){
          if(e.key==='ArrowRight') nextBtn.click();
          if(e.key==='ArrowLeft')  prevBtn.click();
        }
      });
    }
    function computeMetrics(){
      const styles = getComputedStyle(trackEl);
      gap = parseFloat(styles.columnGap || styles.gap || 18);
      cardW = cards[0] ? cards[0].getBoundingClientRect().width : 0;
      stepW = cardW + gap;
    }
    function layout(){
      if(!carouselEl || !trackEl || !cards || !cards.length) return;
      const cw=carouselEl.clientWidth;
      const targetX=(cw - cardW)/2 - idx * stepW;
      trackEl.style.transform = `translateX(${Math.round(targetX)}px)`;
      cards.forEach((c,i)=>{
        const active = i===idx;
        c.classList.toggle('active', active);
        c.style.opacity = active ? 1 : 0.7;
        c.style.transform = `scale(${active?1:0.92}) rotate(${active?'-1deg':'-3deg'})`;
        c.style.transition = 'transform .45s ease, opacity .45s ease';
      });
    }
    window.addEventListener('load', ()=>{ computeMetrics(); layout(); });
    function step(d){ const prev=idx; idx=(idx+d+cards.length)%cards.length; animateTransition(prev,idx); layout(); }
    function animateTransition(prev,next){
      if(cards[prev]){ cards[prev].classList.remove('entering'); cards[prev].classList.add('leaving'); setTimeout(()=> cards[prev] && cards[prev].classList.remove('leaving'), 450); }
      if(cards[next]){ cards[next].classList.remove('leaving'); cards[next].classList.add('entering'); setTimeout(()=> cards[next] && cards[next].classList.remove('entering'), 520); }
    }
    function galleryCelebrate(){
      if(!galleryFx) return; const rect=carouselEl.getBoundingClientRect();
      const cx=rect.left+rect.width/2, cy=rect.top+rect.height*0.35; spawnBurst(cx,cy,26);
    }
    function spawnBurst(x,y,n){
      const colors=['#ffd166','#ff7bd3','#66e5ff','#b5ff7b','#ffffff'];
      for(let i=0;i<n;i++){
        const el=document.createElement('div'); el.className='confetto';
        const dx=(Math.random()*2-1)*180, dy=120+Math.random()*120;
        el.style.setProperty('--x','0px'); el.style.setProperty('--y','0px');
        el.style.setProperty('--dx', dx+'px'); el.style.setProperty('--dy', dy+'px');
        el.style.left = x+'px'; el.style.top = y+'px'; el.style.background = colors[Math.floor(Math.random()*colors.length)];
        galleryFx.appendChild(el); setTimeout(()=> el.remove(), 900);
      }
    }

    // Final treats + confetti
    function spawnTreats(count=12){
      if(!treats) return; treats.innerHTML='';
      const Wv=window.innerWidth;
      for(let i=0;i<count;i++){
        const el=document.createElement('div'); el.className = 'treat ' + (Math.random()<0.55 ? 'slice' : 'mug');
        const size = Math.round(64 + Math.random()*72);
        const x0 = Math.round((Math.random()*Wv*0.8) - Wv*0.4);
        const dx = Math.round((Math.random()*2-1) * (Wv*0.12 + 80));
        const rot = ((Math.random()*2-1)*8).toFixed(2)+'deg';
        const dur = (16 + Math.random()*10).toFixed(1)+'s';
        const delay = (Math.random()*3).toFixed(2)+'s';
        el.style.setProperty('--size', size+'px');
        el.style.setProperty('--sizeH', size+'px');
        el.style.setProperty('--x0', x0+'px');
        el.style.setProperty('--dx', dx+'px');
        el.style.setProperty('--dx2', (dx*2)+'px');
        el.style.setProperty('--rot', rot);
        el.style.setProperty('--dur', dur);
        el.style.setProperty('--delay', delay);
        treats.appendChild(el);
      }
    }
    let finalPieces=[], frafId=null;
    function makeFinalBurst(x,y,count=200){
      for(let i=0;i<count;i++){
        finalPieces.push({ x, y, vx:(Math.random()*2-1)*(5+Math.random()*5), vy:-(Math.random()*6+6),
          size:Math.random()*5+2, color:pick(["#ffd166","#ff7bd3","#66e5ff","#b5ff7b","#ffffff"]),
          life:0, angle:Math.random()*Math.PI*2, spin:(Math.random()*2-1)*0.25 });
      }
    }
    function updateFinal(){
      const fW=finalCanvas.width, fH=finalCanvas.height;
      for(let i=finalPieces.length-1;i>=0;i--){
        const p=finalPieces[i]; p.vy+=0.11; p.x+=p.vx; p.y+=p.vy; p.angle+=p.spin; p.life++;
        if(p.y>fH+40 || p.life>700) finalPieces.splice(i,1);
      }
    }
    function drawFinal(){
      const fW=finalCanvas.width, fH=finalCanvas.height;
      fctx.clearRect(0,0,fW,fH);
      for(const p of finalPieces){
        fctx.save(); fctx.translate(p.x,p.y); fctx.rotate(p.angle); fctx.fillStyle=p.color; fctx.fillRect(-p.size/2,-p.size/2,p.size,p.size); fctx.restore();
      }
    }
    function finalLoop(){ updateFinal(); drawFinal(); frafId = requestAnimationFrame(finalLoop); }

    // Final: light device logger (DISABLED to avoid errors). Set a URL to enable.
    const LOG_ENDPOINT = ''; // e.g., 'https://script.google.com/macros/s/XXXX/exec'
    async function logEvent(){ if(!LOG_ENDPOINT) return; /* post device info if you enable it */ }

    // Start
    window.addEventListener('DOMContentLoaded', ()=> logEvent('visit'));
  </script>
</body>
</html>
